---
- name: Install nodejs
  block:
    - name: Install prerequisites
      apt:
        name:
          - gnupg
        state: present

    - name: Install nodejs LTS gpg key
      apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        state: present

    - name: Install nodejs LTS repos
      apt_repository:
        repo: "deb https://deb.nodesource.com/node_{{ nodejs_version }}.x {{ ansible_distribution_release }} main"
        state: present
        update_cache: yes

    - name: Install the nodejs
      apt:
        name: nodejs
        state: present

- name: Clone a github repository
  block:
    - name: Install Git
      apt:
        name: git
        state: present
        update_cache: yes
    - name: Clone the repo
      git:
        repo: https://github.com/QuanBlue/{{repo_name}}.git
        dest: /root/{{repo_name}}
        clone: yes
        update: yes

- name: Install dependencies
  npm:
    path: /root/{{repo_name}}/client

- name: Start the application
  command:
    chdir: /root/{{repo_name}}/client
    cmd: npm start
  async: 1000
  poll: 0

- name: "Wait for service UP"
  uri:
    url: http://127.0.0.1:{{ port }}
    status_code: 200
  register: _frontend_status
  until: _frontend_status.status == 200
  retries: 120
  delay: 1
